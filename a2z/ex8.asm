#EX8
 ORG :7000
INTJMP=:4019
DFILE=:4023
PCONE=:409A
TXTLIM=:4025
FRAMES=:4070
OFRM1=:16B
MFLAG=:4000
RESTOR=:628
KEYBRD=:143
STMEND=:400F
SAVMEM=:189
NNN=46
TOPS=1
PIXSIZE=1
IDLE=30
RASTERS=255
DISPEND=:6501
DSTART=:4100
;
KERNEL LD HL,ONEP
  LD (INTJMP),HL
  CALL CLEAR
  LD HL,UPROG
  LD (PCONE),HL
;
ONEP CALL KEYBRD
  LD HL, (FRAMES)
  INC HL
  LD (FRAMES),HL
  LD B, IDLE
  DJNZ $
  LD D,PIXSIZE
  LD B,RASTERS
  LD C,TOPS
  CALL OFRM1
  LD A,1
  LD (MFLAG),A
  LD C,NNN+NNN+1
  EXX
  JP RESTOR
;
CLEAR LD HL,DSTART
  LD DE,DSTART+2
  LD BC,:2400
  LD (HL),:76
  LD (DFILE),HL
  INC HL
  LD (HL),0
  LDIR
  RET
;
PLOT LD D,15
  JR $+4
UNPLOT LD D,0
  LD A,3
  AND C
  SRL C
  SRL C
  INC A 
  LD E,16
LOOP1 SRL E
  DEC A
  JR NZ,LOOP1
  CP D
  JR NZ,ENT2
  LD A,E
  CPL
  LD D,A
ENT2 PUSH DE
  LD HL,DISPEND
  LD DE,:1200
  LD A,B
  LD B,8
LOOP2 RLCA
  JR NC,NOSUBT
  OR A
  SBC HL,DE
NOSUBT SRL D
  RR E
  DJNZ LOOP2
  ADD HL,BC
  POP DE
  LD A, (HL)
  BIT 7,A
  JR Z,$+3
  CPL
  AND 15
  OR E
  AND D
  CP 8
  JR C,NOTINV
  CPL
  AND :87
NOTINV LD (HL),A
;
  RET
NLINE LD DE,FRAMES
 LD A, (DE)
  LD B,A
LOOPX LD A, (DE)
  CP B
  JR Z,LOOPX
  RET
;
LINE LD A,15
  JR $+3
UNLINE XOR A
  LD (DORDEL),A
 LD HL,XMID
  XOR A
  LD (HL),A
  INC HL
  LD (HL),E
  INC HL
  LD (HL),A
  INC HL
  LD (HL),D
  INC HL
  LD (HL),C
  INC HL
  LD (HL),B
;
  LD L,C
  LD D,A
  LD H,A
  SBC HL,DE
  PUSH HL
  LD L,B
  LD H,A
  LD A, (YMID+1)
  LD E,A
  SBC HL,DE
  POP DE
;
JUSTIFY LD C,L
  LD A,H
  RLCA
  RL L
  ADC A,0
  EX AF,AF'
  LD B,E
  LD A,D
  RLCA
  RL E
  ADC A,0
  JR NZ,JSTDUN
  EX AF,AF'
  JR Z,JUSTIFY
JSTDUN LD E,B
  LD B,H
;
LLOOP LD HL, (XMID)
  ADD HL,DE
  LD (XMID),HL
  LD HL, (YMID)
  ADD HL,BC
  LD (YMID),HL
  EXX
LPLOT LD A, (XMID+1)
  LD C,A
  LD A, (YMID+1)
  LD B,A
  LD A, (DORDEL)
  LD D,A
  CALL UNPLOT+2
  LD HL,XPRIM
  LD A,(XMID+1)
  CP (HL)
  INC HL
  EX AF,AF'
  LD A,(YMID+1)
  CP (HL)
  EXX
  JR NZ,NYLIM
  LD BC,0
NYLIM EX AF,AF'
  JR NZ,NXLIM
  LD DE,0
NXLIM  LD A,D
  OR E
  OR B
  OR C
  JR NZ,LLOOP
  RET
;
XMID DEFW 0
YMID DEFW 0
XPRIM DEFB 0
YPRIM DEFB 0
DORDEL DEFB 0
;
; MOIRE
;
UPROG LD SP,:7F00
MAINLOOP LD DE,:4078
 LD BC,:101
MLOOP PUSH DE
 PUSH BC
 CALL LINE
 POP BC
 POP DE
 INC D
 INC D
 INC B
 INC B
 INC B
 INC B
 LD A, 250
 CP B
 JR C,OUTCOD
 LD A, (STMEND)
 AND 1
 JR NZ,MLOOP
 LD HL,:8000
 JP SAVMEM
OUTCOD CALL CLEAR
 JP MAINLOOP
#
A#EX8
H:7000
